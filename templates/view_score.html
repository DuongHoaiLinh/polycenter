<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kết Quả Học Tập - Trung Tâm Dạy Học</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="stylesheet" href="/static/css/lichhoccuatoi.css">
  <link rel="stylesheet" href="/static/css/footer.css">
</head>
<body>

<!-- Navbar -->
<nav class="navbar" id="navbar">
  <div class="logo"><span>Poly </span>Center</div>
  <ul class="nav-links" id="navLinks">
    <li><a href="index.html">Trang Chủ</a></li>
    <li class="dropdown">
      <a href="#">Giới thiệu ▾</a>
      <ul class="dropdown-content">
        <li><a href="tamnhin_sumenh.html">Tầm nhìn & sứ mệnh</a></li>
        <li><a href="cosovatchat.html">Cơ sở vật chất</a></li>
        <li><a href="doingugiaovien.html">Đội ngũ giáo viên</a></li>
      </ul>
    </li>
    <li><a href="khoahoc.html">Khóa Học</a></li>
    <li class="dropdown">
      <a href="#">Học Viên ▾</a>
      <ul class="dropdown-content">
        <li><a href="tailieuhoc.html">Tài liệu học</a></li>
        <li><a href="lichhoccuatoi.html">Lịch học của tôi</a></li>
        <li><a href="view_score.html" class="active">Kết quả học tập</a></li>
        <li><a href="xinphepvang.html">báo vắng</a></li>
      </ul>
    </li>
    <li class="dropdown user-menu" id="teacherMenu" style="display: none;">
      <a href="#">Giáo Viên ▾</a>
      <ul class="dropdown-content">
        <li><a href="quanlilophoc.html">Quản lý lớp</a></li>
        <li><a href="uploadtailieu.html">Upload tài liệu</a></li>
        <li><a href="lichday.html">Lịch dạy</a></li>
        <li><a href="enter_score.html">Nhập điểm</a></li>
      </ul>
    </li>
    <li id="registerNav"><a href="register.html">Đăng Ký</a></li>
    <li><a href="#">Liên Hệ</a></li>
    <li id="loginNav"><a href="login.html">Đăng Nhập</a></li>
    <li id="logoutNav" style="display: none;"><a href="#" id="logoutBtn">Đăng Xuất</a></li>
  </ul>
  <div class="burger" onclick="toggleMenu()">
    <div class="line1"></div>
    <div class="line2"></div>
    <div class="line3"></div>
  </div>
</nav>

<!-- KẾT QUẢ HỌC TẬP -->
<div class="container-schedule">
    <h2 class="schedule-title">Kết Quả Học Tập Của Tôi</h2>
    <div class="schedule-filter">
      <label for="filter-course">Lọc theo khóa học:</label>
      <select id="filter-course">
        <option value="">Tất cả khóa học</option>
      </select>
      <label for="filter-status">Trạng thái:</label>
      <select id="filter-status">
        <option value="">Tất cả</option>
        <option value="Đạt">Đạt</option>
        <option value="Không Đạt">Không Đạt</option>
      </select>
      <button id="apply-filter" class="filter-btn">Lọc</button>
    </div>
    <div class="schedule-table-wrapper">
      <table class="schedule-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>Khóa học</th>
            <th>Điểm</th>
            <th>Ngày Kiểm Tra</th>
            <th>Trạng thái</th>
          </tr>
        </thead>
        <tbody id="scoreBody">
          <!-- Dữ liệu sẽ được chèn tự động bằng JavaScript -->
        </tbody>
      </table>
    </div>
    <div id="loading-indicator" class="loading">Đang tải dữ liệu...</div>
    <div id="message" class="message"></div>
</div>

<!-- Phần chân trang -->
<footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-column">
          <div class="footer-logo">
            <span class="poly-color">Poly</span> Center
          </div>
          <p>Future in Language</p>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-tiktok"></i></a>
          </div>
        </div>
        <div class="footer-column">
          <h3>Liên kết nhanh</h3>
          <ul>
            <li><a href="index.html">Trang chủ</a></li>
            <li><a href="tamnhin_sumenh.html">Giới thiệu</a></li>
            <li><a href="courses.html">Khóa học</a></li>
            <li><a href="#">Lịch học</a></li>
            <li><a href="register.html">Đăng ký</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Khóa học</h3>
          <ul>
            <li><a href="#">Tiếng Anh Giao Tiếp</a></li>
            <li><a href="#">Tiếng Anh Thiếu Nhi</a></li>
            <li><a href="#">Tiếng Anh IELTS</a></li>
            <li><a href="#">Tiếng Nhật</a></li>
            <li><a href="#">Tiếng Hàn</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Liên hệ</h3>
          <ul class="contact-info">
            <li><i class="fas fa-map-marker-alt"></i> 123 Đường ABC, Quận XYZ, TP.HCM</li>
            <li><i class="fas fa-phone"></i> 0123 456 789</li>
            <li><i class="fas fa-envelope"></i> info@polycenter.edu.vn</li>
            <li><i class="fas fa-clock"></i> T2-T6: 8:00 - 20:00, T7-CN: 8:00 - 17:00</li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p>© 2025 Poly Center. Tất cả quyền được bảo lưu.</p>
      </div>
    </div>
</footer>

<script>
let allScores = []; // Lưu dữ liệu điểm sau khi load lần đầu

document.addEventListener("DOMContentLoaded", function() {
    const userId = sessionStorage.getItem('user_id');
    const userRole = sessionStorage.getItem('role');
    //const authToken = sessionStorage.getItem('auth_token');

    if (!userId || !userRole )//|| !authToken) 
    {
        window.location.href = 'login.html';
        return;
    }

    updateNavigation(userRole);
    loadScoreData(); // Gọi khi trang tải
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        logout();
    });
    document.getElementById('apply-filter').addEventListener('click', filterScoreData);
});

function updateNavigation(role) {
    document.getElementById('loginNav').style.display = 'none';
    document.getElementById('registerNav').style.display = 'none';
    document.getElementById('logoutNav').style.display = 'block';
    if (role === 'teacher') {
        document.getElementById('teacherMenu').style.display = 'block';
    }
}

function logout() {
    fetch('http://127.0.0.1:5000/api/logout', {
        method: 'POST',
        credentials: 'include'
    })
    .then(res => res.json())
    .then(data => {
        sessionStorage.removeItem('user_id');
        sessionStorage.removeItem('role');
        sessionStorage.removeItem('auth_token');
        window.location.href = 'index.html';
    })
    .catch(err => {
        console.error('Lỗi khi đăng xuất:', err);
      // Trong trường hợp lỗi, vẫn xóa dữ liệu local và chuyển về trang chủ
        sessionStorage.removeItem('user_id');
        sessionStorage.removeItem('role');
        sessionStorage.removeItem('auth_token');
        sessionStorage.clear();
        window.location.href = 'index.html';
    });
}

// Tải điểm một lần
function loadScoreData() {
    const userId = sessionStorage.getItem('user_id');
    const authToken = sessionStorage.getItem('auth_token');
    const headers = { 'Content-Type': 'application/json' };
    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('message').style.display = 'none';

    fetch(`http://127.0.0.1:5000/api/student/${userId}/scores`, {
        method: 'GET',
         headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')  // Lưu ý phải lưu token khi đăng nhập
        },
        credentials: 'include'  // Để cookie session cũng được gửi nếu có
    })
    .then(res => res.json())
    .then(data => {
        console.log("API trả về:", data);
        if (Array.isArray(data)) {
            displayScoreData(data);
        } else {
            alert(data.error || "Lỗi không xác định.");
        }
    })// Thêm dòng này để xem cấu trúc dữ liệu
    .then(data => {
        document.getElementById('loading-indicator').style.display = 'none';
        if (!data || data.length === 0) {
            document.getElementById('message').textContent = 'Bạn chưa có điểm nào.';
            document.getElementById('message').style.display = 'block';
            return;
        }
        allScores = data; // Lưu để lọc về sau
        displayScoreData(data);
        updateCourseFilter(data);
    })
    .catch(err => {
        console.error('Lỗi khi tải điểm:', err);
        document.getElementById('loading-indicator').style.display = 'none';
        document.getElementById('message').textContent = 'Không thể tải dữ liệu điểm. Vui lòng thử lại sau.';
        document.getElementById('message').style.display = 'block';
    });
}

function displayScoreData(data) {
    const tbody = document.getElementById('scoreBody');
    tbody.innerHTML = '';

    data.forEach((item, index) => {
        const statusClass = item.status === 'Đạt' ? 'status-active' : 'status-completed';
        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${item.course_id}</td>
                <td>${item.score}</td>
                <td>${item.test_date}</td>
                <td class="${statusClass}">${item.status}</td>
            </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function updateCourseFilter(data) {
    const courseFilter = document.getElementById('filter-course');
    const courses = [...new Set(data.map(d => d.course_id))];
    courseFilter.innerHTML = `<option value="">Tất cả khóa học</option>`;
    courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        courseFilter.appendChild(option);
    });
}

function filterScoreData() {
    const course = document.getElementById('filter-course').value;
    const status = document.getElementById('filter-status').value;

    const filtered = allScores.filter(item => {
        return (course === '' || item.course_id === course) &&
               (status === '' || item.status === status);
    });

    if (filtered.length === 0) {
        document.getElementById('message').textContent = 'Không tìm thấy kết quả phù hợp với điều kiện lọc.';
        document.getElementById('message').style.display = 'block';
        document.getElementById('scoreBody').innerHTML = '';
    } else {
        document.getElementById('message').style.display = 'none';
        displayScoreData(filtered);
    }
}
</script>

</body>
</html>